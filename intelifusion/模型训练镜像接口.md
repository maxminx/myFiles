# 模型训练镜像说明

| 版本  | 修订日期 |                         版本更新说明                         |
| :---: | :------: | :----------------------------------------------------------: |
| 1.1.1 | 20211028 |                增加YoloV3检测模型的训练和推理                |
| 1.1.0 | 20210908 | 使用重构后VisualTL训练镜像<br>分类模型和REID模型支持目标框<br>增加迭代训练功能 |
| 1.0.1 | 20210806 |                     训练结束后Sleep 30秒                     |
| 1.0.0 | 20210707 |                             初版                             |

## 零、加载预训练模型参数

为了节省从网络下载预训练模型参数的时间，或在无法连接互联网环境的情况下，请先将预训练模型目录挂载到容器`/root/.mxnet/models`目录下



## 一、物体检测模型

### 1. 准备训练数据

需要准备三个训练图片集：训练集、验证集和测试集（可选）



#### 1.1 支持的图片格式

当前支持扩展名为`.jpg`、 `.jpeg`、 `.png`、 `.bmp`（注意大小写）的图片

若非以上格式图片，请使用图片格式转换工具转换为可支持类型图片，请勿强制修改扩展名



#### 1.2 标注文件

| 参数名 | 说明                |
| ------ | ------------------- |
| id     | 类型ID              |
| x1     | 目标框左上角的x坐标 |
| y1     | 目标框左上角的y坐标 |
| x2     | 目标框右下角的x坐标 |
| y2     | 目标框右小角的y坐标 |

每张图片需要有一个对应的标注TXT文件，需与图片文件名一致，且放在同一目录下，例如：1.jpg，1.txt。

标注TXT文件中，每一行表示一个目标。

假设有三个目标，则标注TXT文件如下：

```
id1,x11,y11,x12,y12
id2,x21,y21,x22,y22
id3,x31,y31,x32,y32
```

如果该图片中没有任何需要检测的物体，则标注TXT文件如下：

```
-1，-1，-1，-1，-1
```



#### 1.3 目录结构

三个训练图片集请按以下目录结构放置。

```
/data                             // 训练数据的根目录，对应配置文件中参数dataset.data_root
├── detect_train                  // 训练集数据文件夹，对应配置文件中参数dataset.train_dir
│   ├── 000000000009.jpg          // 图片
│   ├── 000000000009.txt          // 图片对应标注文件，格式：id,x1,y1,x2,y2
│   ├── 000000000025.jpg
│   ├── 000000000025.txt
│   ├── 000000000030.jpg
│   ├── 000000000030.txt
│   ├── 000000000034.jpg
│   ├── 000000000034.txt

├── detect_valid                  // 验证集集数据文件夹，对应配置文件中参数dataset.valid_dir
│   ├── 000000000139.jpg
│   ├── 000000000139.txt
│   ├── 000000000285.jpg
│   ├── 000000000285.txt
│   ├── 000000000632.jpg
│   ├── 000000000632.txt

├── detect_test                  // 测试集集数据文件夹，对应配置文件中参数dataset.test_dir
│   ├── 000000002139.jpg
│   ├── 000000002139.txt
│   ├── 000000002285.jpg
│   ├── 000000002285.txt
│   ├── 000000002632.jpg
│   ├── 000000002632.txt
```



### 2. 训练检测网络

#### 2.1 CenterNet检测网络

##### 2.1.1 准备训练JSON配置文件

配置文件示例

```json
{
  "log_dir": "/out",
  "dataset": {
    "data_root": "/data",
    "train_dir": "detect_train",
    "valid_dir": "detect_valid",
    "test_dir": "detect_test",
    "valid_size": 0.0,
    "test_size": 0.0,
    "classes": [
      "cat",
      "dog"
    ]
  },
  "gpus": [
    1
  ],
  "model": {
    "base_network": "resnet18_v1b_dcnv2",
    "use_pretrained": true,
    "transfer_dataset": "coco",
    "scale": 4.0,
    "topk": 100,
    "wh_weight": 0.1,
    "center_reg_weight": 1.0,
    "data_shape": [
      512,
      512
    ]
  },
  "train": {
    "pretrained_base": true,
    "batch_size": 8,
    "epochs": 100,
    "lr": 0.01,
    "lr_decay": 0.1,
    "lr_decay_period": 0,
    "lr_decay_epoch": "25,50,75",
    "lr_mode": "step",
    "warmup_lr": 0.0,
    "warmup_epochs": 0,
    "num_workers": 16,
    "momentum": 0.9,
    "start_epoch": 0,
    "transfer_lr_mult": 0.01,
    "output_lr_mult": 0.1,
    "wd": 0.0001,
    "log_interval": 50,
    "early_stop_patience": -1,
    "early_stop_min_delta": 0.001,
    "early_stop_baseline": 0.0,
    "early_stop_max_value": 1.0
  },
  "valid": {
    "flip_test": true,
    "nms_thresh": 0,
    "nms_topk": 400,
    "post_nms": 100,
    "interval": 1,
    "metric": "voc",
    "iou_thresh": 0.5,
    "score_thresh": 0.3
  }
}
```



| 参数名                     | 默认值                 | 参数类型 | 必填参数 | 参数描述                                   | 备注                                                         |
| -------------------------- | ---------------------- | -------- | -------- | ------------------------------------------ | ------------------------------------------------------------ |
| log_dir                    | 无                     | String   | 必填     | 日志和结果保存目录                         | 训练的日志：estimator.log<br>训练的模型：xxx.json  xxx.params<br>迭代使用文件：best_checkpoint.pkl<br>验证集结果：valid_data_result.json<br>测试集结果：test_data_result.json |
| dataset                    |                        | Struct   |          |                                            |                                                              |
| dataset.data_root          | /data/aios/data/detect | Text     | 必填     | 训练数据根目录                             | 训练集，验证集，测试集存放的根目录                           |
| dataset.train_dir          | detect_train           | Text     | 必填     | 训练集数据子目录名                         | 训练集相对路径                                               |
| dataset.valid_dir          | detect_valid           | Text     | 可选     | 验证集数据子目录名                         | 验证集相对路径                                               |
| dataset.test_dir           | detect_test            | Text     | 可选     | 测试集数据子目录名                         | 测试集相对路径                                               |
| dataset.valid_size         | 0                      | Text     | 高级     | 验证集比例                                 | 取值范围[0, 1)<br>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分valid_size作为验证集数据 |
| dataset.test_size          | 0                      | Text     | 高级     | 测试集比例                                 | 取值范围[0, 1)<br/>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分test_size作为测试集数据 |
| dataset.classes            | None                   | Array    | 可选     | 训练数据的类别名称，与标注文件中id顺序对应 | 根据标注文件中类别ID顺序提供类别标签名称，如['cat', 'dog']<br>如为None，则根据ID生成标签class0, class1, .... |
| gpus                       | 0                      | Array    | 必填     | 训练使用的GPU卡ID                          | 指定训练使用的GPU卡ID                                        |
| model                      |                        | Struct   |          | 训练模型信息                               |                                                              |
| model.base_network         | resnet18_v1b_dcnv2     | Text     | 可选     | 骨干网络                                   | CenterNet使用的骨干网络<br>可选骨干网络列表：<br>resnet18_v1b<br>resnet18_v1b_dcnv2<br>resnet50_v1b<br>resnet50_v1b_dcnv2<br>resnet101_v1b<br>resnet101_v1b_dcnv2 |
| model.use_pretrained       | true                   | Text     | 可选     | 是否使用预训练模型                         |                                                              |
| model.transfer_dataset     | coco                   | Text     | 可选     | 预训练模型使用的数据集                     | 可选值：<br>coco<br>voc                                      |
| model.scale                | 4                      | Text     | 高级     |                                            | output vs input scaling ratio, e.g., input_h // feature_h    |
| model.topk                 | 100                    | Text     | 高级     |                                            | 只保留topk个检测推理结果                                     |
| model.wh_weight            | 0.1                    | Text     | 高级     |                                            | Loss weight for width/height                                 |
| model.center_reg_weight    | 1                      | Text     | 高级     |                                            | Center regression loss weight                                |
| model.data_shape           | [512, 512]             | Text     | 可选     |                                            | 模型输入分辨率                                               |
| train                      |                        | Struct   |          | 模型训练参数                               |                                                              |
| train.pretrained_base      | true                   | Text     | 高级     | 骨干网络使用预训练参数                     | 当model.use_pretrained为False，本参数才生效                  |
| train.batch_size           | 16                     | Text     | 可选     |                                            |                                                              |
| train.epochs               | 100                    | Text     | 可选     |                                            |                                                              |
| train.lr                   | 0.01                   | Text     | 可选     | 学习率                                     |                                                              |
| train.lr_decay             | 0.1                    | Text     | 高级     | 学习率衰减系数                             |                                                              |
| train.lr_decay_period      | 0                      | Text     | 高级     |                                            |                                                              |
| train.lr_decay_epoch       | 25,50,75               | Text     | 高级     | 学习率消减步数                             | lr_mode为step时生效                                          |
| train.lr_mode              | step                   | Text     | 高级     | 学习率衰减模式                             | 可选模式<br>step<br>poly<br>cosine                           |
| train.warmup_lr            | 0                      | Text     | 高级     |                                            | starting warmup learning rate                                |
| train.warmup_epochs        | 0                      | Text     | 高级     |                                            | number of warmup epochs                                      |
| train.num_workers          | 16                     | Text     | 可选     |                                            | cpu workers, the larger the more processes used              |
| train.momentum             | 0.9                    | Text     | 高级     |                                            | SGD momentum                                                 |
| train.start_epoch          | 0                      | Text     | 高级     |                                            |                                                              |
| train.transfer_lr_mult     | 0.01                   | Text     | 高级     |                                            | reduce the backbone lr_mult to avoid quickly destroying the features |
| train.output_lr_mult       | 0.1                    | Text     | 高级     |                                            | the learning rate multiplier for last fc layer if trained with transfer learning |
| train.wd                   | 0.0001                 | Text     | 高级     |                                            | weight decay                                                 |
| train.log_interval         | 50                     | Text     | 高级     |                                            | logging interval                                             |
| train.early_stop_patience  | -1                     | Text     | 高级     |                                            | epochs with no improvement after which train is early stopped, negative: disabled |
| train.early_stop_min_delta | 0.001                  | Text     | 高级     |                                            | ignore changes less than min_delta for metrics               |
| train.early_stop_baseline  | 0                      | Text     | 高级     |                                            | the baseline value for metric, training won't stop if not reaching baseline |
| train.early_stop_max_value | 1                      | Text     | 高级     |                                            | early stop if reaching max value instantly                   |
| valid                      |                        | Struct   |          | 模型验证参数                               |                                                              |
| valid.flip_test            | true                   | Text     | 高级     |                                            | 对验证图像进行翻转                                           |
| valid.nms_thresh           | 0                      | Text     | 高级     |                                            | nms阈值                                                      |
| valid.nms_topk             | 400                    | Text     | 高级     |                                            | pre nms topk                                                 |
| valid.post_nms             | 100                    | Text     | 高级     |                                            | post nms topk                                                |
| valid.interval             | 1                      | Text     | 高级     |                                            | validation epoch interval, for slow validations              |
| valid.metric               | voc                    | Text     | 高级     |                                            | metric                                                       |
| valid.iou_thresh           | 0.5                    | Text     | 高级     |                                            | iou_thresh for VOC type metrics                              |
| valid.score_thresh         | 0.3                    | Text     | 高级     |                                            |                                                              |



##### 2.1.2 启动模型训练

一个训练任务启动一个容器进行训练

 docker启动示例

```shell
nvidia-docker run -it --rm --shm-size=128G -p 8888:8888 -v /data/aios/data:/data -v /data/aios/out:/out mxnet_train:1.1.0 python3 detect/fit_center_net.py --config detect_center_net.json
```

###### 2.1.2.1 nvidia-docker参数

`-v /data/aios/data:/data`

​		`/data/aios/data`：训练数据存放的路径，根据实际具体的存放路径填写

​		`/data`：挂载到容器内的路径

`-v /data/aios/out:/out`

​		`/data/aios/out`：训练结果保存的路径，根据实际具体路径填写

​		`/out`：挂载到容器内的路径

`-p HOSTPORT:8888`：把容器内部端口8888映射到宿主机HOSTPORT端口上，用于获取进度

`--shm-size`：共享内存大小，建议设置大一些，否则影响训练

###### 2.1.2.2 python脚本参数

`--config`：配置文件，详细设置见2.1

`--load`:  需要进行迭代训练时才设置，加载上次训练得到的best_checkpoint.pkl文件。非迭代训练时，请勿设置。

​                 当使用迭代训练时，配置文件中model字段的参数无效。



#### 2.2 YoloV3检测网络

##### 2.2.1 准备训练JSON配置文件

配置文件示例

```json
{
  "log_dir": "/out",
  "dataset": {
    "data_root": "/data",
    "train_dir": "detect_train",
    "valid_dir": "detect_valid",
    "test_dir": "detect_test",
    "valid_size": 0.0,
    "test_size": 0.0,
    "classes": [
      "cat",
      "dog"
    ]
  },
  "gpus": [
    0
  ],
  "model": {
    "base_network": "darknet53",
    "use_pretrained": true,
    "transfer_dataset": "coco",
    "data_shape": [
      512,
      512
    ],
    "syncbn": false,
    "amp": false
  },
  "train": {
    "batch_size": 8,
    "epochs": 100,
    "lr": 0.001,
    "lr_decay": 0.1,
    "lr_decay_period": 0,
    "lr_decay_epoch": "25,50,75",
    "lr_mode": "step",
    "warmup_lr": 0.0,
    "warmup_epochs": 0,
    "num_workers": 16,
    "momentum": 0.9,
    "start_epoch": 0,
    "output_lr_mult": 0.1,
    "wd": 0.0001,
    "log_interval": 50,
    "early_stop_patience": -1,
    "early_stop_min_delta": 0.001,
    "early_stop_baseline": 0.0,
    "early_stop_max_value": 1.0
  },
  "valid": {
    "interval": 1,
    "metric": "voc",
    "iou_thresh": 0.5,
    "score_thresh": 0.3
  }
}
```



| 参数名                     | 默认值                 | 参数类型 | 必填参数 | 参数描述                                   | 备注                                                         |
| -------------------------- | ---------------------- | -------- | -------- | ------------------------------------------ | ------------------------------------------------------------ |
| log_dir                    | 无                     | String   | 必填     | 日志和结果保存目录                         | 训练的日志：estimator.log<br>训练的模型：xxx.json  xxx.params<br>迭代使用文件：best_checkpoint.pkl<br>验证集结果：valid_data_result.json<br>测试集结果：test_data_result.json |
| dataset                    |                        | Struct   |          |                                            |                                                              |
| dataset.data_root          | /data/aios/data/detect | Text     | 必填     | 训练数据根目录                             | 训练集，验证集，测试集存放的根目录                           |
| dataset.train_dir          | detect_train           | Text     | 必填     | 训练集数据子目录名                         | 训练集相对路径                                               |
| dataset.valid_dir          | detect_valid           | Text     | 可选     | 验证集数据子目录名                         | 验证集相对路径                                               |
| dataset.test_dir           | detect_test            | Text     | 可选     | 测试集数据子目录名                         | 测试集相对路径                                               |
| dataset.valid_size         | 0                      | Text     | 高级     | 验证集比例                                 | 取值范围[0, 1)<br>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分valid_size作为验证集数据 |
| dataset.test_size          | 0                      | Text     | 高级     | 测试集比例                                 | 取值范围[0, 1)<br/>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分test_size作为测试集数据 |
| dataset.classes            | None                   | Array    | 可选     | 训练数据的类别名称，与标注文件中id顺序对应 | 根据标注文件中类别ID顺序提供类别标签名称，如['cat', 'dog']<br>如为None，则根据ID生成标签class0, class1, .... |
| gpus                       | 0                      | Array    | 必填     | 训练使用的GPU卡ID                          | 指定训练使用的GPU卡ID                                        |
| model                      |                        | Struct   |          | 训练模型信息                               |                                                              |
| model.base_network         | darknet53              | Text     | 可选     | 骨干网络                                   | YoloV3使用的骨干网络<br>可选骨干网络列表：<br>darknet53<br>mobilenet1.0 |
| model.use_pretrained       | true                   | Text     | 可选     | 是否使用预训练模型                         |                                                              |
| model.transfer_dataset     | coco                   | Text     | 可选     | 预训练模型使用的数据集                     | 可选值：<br>coco<br>voc                                      |
| model.data_shape           | [416, 416]             | Text     | 可选     |                                            | 模型输入分辨率                                               |
| train                      |                        | Struct   |          | 模型训练参数                               |                                                              |
| train.batch_size           | 16                     | Text     | 可选     |                                            |                                                              |
| train.epochs               | 100                    | Text     | 可选     |                                            |                                                              |
| train.lr                   | 0.001                  | Text     | 可选     | 学习率                                     |                                                              |
| train.lr_decay             | 0.1                    | Text     | 高级     | 学习率衰减系数                             |                                                              |
| train.lr_decay_period      | 0                      | Text     | 高级     |                                            |                                                              |
| train.lr_decay_epoch       | 25,50,75               | Text     | 高级     | 学习率消减步数                             | lr_mode为step时生效                                          |
| train.lr_mode              | step                   | Text     | 高级     | 学习率衰减模式                             | 可选模式<br>step<br>poly<br>cosine                           |
| train.warmup_lr            | 0                      | Text     | 高级     |                                            | starting warmup learning rate                                |
| train.warmup_epochs        | 0                      | Text     | 高级     |                                            | number of warmup epochs                                      |
| train.num_workers          | 16                     | Text     | 可选     |                                            | cpu workers, the larger the more processes used              |
| train.momentum             | 0.9                    | Text     | 高级     |                                            | SGD momentum                                                 |
| train.start_epoch          | 0                      | Text     | 高级     |                                            |                                                              |
| train.output_lr_mult       | 0.1                    | Text     | 高级     |                                            | the learning rate multiplier for last fc layer if trained with transfer learning |
| train.wd                   | 0.0001                 | Text     | 高级     |                                            | weight decay                                                 |
| train.log_interval         | 50                     | Text     | 高级     |                                            | logging interval                                             |
| train.early_stop_patience  | -1                     | Text     | 高级     |                                            | epochs with no improvement after which train is early stopped, negative: disabled |
| train.early_stop_min_delta | 0.001                  | Text     | 高级     |                                            | ignore changes less than min_delta for metrics               |
| train.early_stop_baseline  | 0                      | Text     | 高级     |                                            | the baseline value for metric, training won't stop if not reaching baseline |
| train.early_stop_max_value | 1                      | Text     | 高级     |                                            | early stop if reaching max value instantly                   |
| valid                      |                        | Struct   |          | 模型验证参数                               |                                                              |
| valid.interval             | 1                      | Text     | 高级     |                                            | validation epoch interval, for slow validations              |
| valid.metric               | voc                    | Text     | 高级     |                                            | metric                                                       |
| valid.iou_thresh           | 0.5                    | Text     | 高级     |                                            | iou_thresh for VOC type metrics                              |
| valid.score_thresh         | 0.3                    | Text     | 高级     |                                            |                                                              |



##### 2.2.2 启动模型训练

一个训练任务启动一个容器进行训练

 docker启动示例

```shell
nvidia-docker run -it --rm --shm-size=128G -p 8888:8888 -v /data/aios/data:/data -v /data/aios/out:/out mxnet_train:1.1.0 python3 detect/fit_yolov3.py --config detect_yolov3.json
```

###### 2.2.2.1 nvidia-docker参数

`-v /data/aios/data:/data`

​		`/data/aios/data`：训练数据存放的路径，根据实际具体的存放路径填写

​		`/data`：挂载到容器内的路径

`-v /data/aios/out:/out`

​		`/data/aios/out`：训练结果保存的路径，根据实际具体路径填写

​		`/out`：挂载到容器内的路径

`-p HOSTPORT:8888`：把容器内部端口8888映射到宿主机HOSTPORT端口上，用于获取进度

`--shm-size`：共享内存大小，建议设置大一些，否则影响训练

###### 2.2.2.2 python脚本参数

`--config`：配置文件，详细设置见2.1

`--load`:  需要进行迭代训练时才设置，加载上次训练得到的best_checkpoint.pkl文件。非迭代训练时，请勿设置。

​                 当使用迭代训练时，配置文件中model字段的参数无效。



### 3. 获取训练结果

训练结果会产生在配置文件中的`log_dir`目录



#### 3.1 训练日志estimator.log



#### 3.2 验证集结果valid_data_result.json

JSON文件内容如下：

```json
{
    "AP": [
        {
            "dog": "0.4797081864339048"
        },
        {
            "cat": "0.42457933298336026"
        },
        {
            "mAP": "0.4521437597086325"
        }
    ],
    "Result": [
        {
            "image": "/data/Dataset/ComunityDog/new/convert/21.jpg",
            "objects": []
        },
        {
            "image": "/data/Dataset/ComunityDog/new/convert/26.jpg",
            "objects": [
                {
                    "predict_class": "cat",
                    "id": "0",
                    "score": "0.49056703",
                    "bbox": "107.611855, 4.885638, 525.262024, 391.273621"
                },
                {
                    "predict_class": "cat",
                    "id": "0",
                    "score": "0.35233077",
                    "bbox": "113.309097, 3.023881, 575.644104, 393.121185"
                }
            ]
        }
    ]
}
```



#### 3.3 测试集结果test_data_result.json

与3.2一致



#### 3.4 本次训练最优模型xxx.json  xxx.params



#### 3.5 迭代训练使用的文件best_checkpoint.pkl



### 4. 获取进度

#### 4.1 接口URL

> http://0.0.0.0:8888/data/plugin/scalars/scalars?run=.&tag=progress

#### 4.2 请求方式

> POST

#### 4.3 成功响应示例

```
[
    [1629087911.0446773,        1,        0.0],
    [1629087911.346133,         1,        1.0],
    [1629087911.346491,         2,        0.0],
    [1629087911.3539176,        2,      0.01785714365541935],
    [1629087911.4217741,        2,        1.0],
    [1629087911.422071,         4,        0.0],
    [1629087911.495037,         4,        1.0],
    [1629087918.0763917,       10,        0.0],
    [1629087937.983495,        10,        1.0],
    [1629087939.968718,        20,        0.0],
    [1629087942.8499782,       20,        1.0],
    [1629087942.870176,        21,        0.0],
    [1629087945.651394,        21,        1.0],
    [1629087953.271594,        30,        0.0],
    [1629087959.218388,        30,        1.0]
]
```

| 参数名    | 参数描述 | 备注                                                         |
| --------- | -------- | ------------------------------------------------------------ |
| timestamp | 时间戳   | 当前条目产生的时间戳                                         |
| step      | 当前步骤 | LOAD_TRAIN_DATA = 1                        加载训练集<br/>LOAD_VALID_DATA = 2                         加载验证集<br/>LOAD_TRAIN_VALID_DATA = 3            加载训练集和验证集<br/>LOAD_TEST_DATA = 4                           加载测试集<br/>LOAD_ALL_DATA = 7                             加载训练集，验证集和测试集<br/>TRAIN = 10                                              训练中<br/>PREDICT_VALID = 20                             获取验证集结果<br/>PREDICT_TEST = 21                               获取测试集结果<br/>EXPORT = 30                                           导出模型 |
| progress  | 进度     | 当前步骤进度的百分比                                         |



## 二、图像分类模型训练

### 1. 准备训练数据

需要准备三个训练图片集：训练集、验证集和测试集（可选）



#### 1.1 支持的图片格式

当前支持扩展名为`.jpg`、 `.jpeg`、 `.png`、 `.bmp`（注意大小写）的图片

若非以上格式图片，请使用图片格式转换工具转换为可支持类型图片，请勿强制修改扩展名



#### 1.2 标注文件

相同分类的图片放到已该分类命名的文件夹下。

例如一个三分类任务，三个类别索引为A，B，C，则

训练集数据存放格式为：train/A/\*\*\*\*.jpg、train/B/\*\*\*\*.jpg、train/C/\*\*\*\*.jpg

验证集数据存放格式为：valid/A/\*\*\*\*.jpg、valid/B/\*\*\*\*.jpg、valid/C/\*\*\*\*.jpg

如果是带目标框的，每张图片需要有一个对应的TXT文件，需与图片文件名一致，且放在同一目录下，例如：1.jpg，1.txt。



#### 1.3 目录结构

```
/data
├── train                         // 训练集
│   ├── class01                   // 类别0，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class02                   // 类别1，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class03                   // 类别2，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class04                   // 类别3，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt

├── valid                         // 验证集
│   ├── class01                   // 类别0，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class02                   // 类别1，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class03                   // 类别2，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class04                   // 类别3，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt

├── test                          // 测试集
│   ├── class01                   // 类别0，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class02                   // 类别1，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class03                   // 类别2，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class04                   // 类别3，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
```



### 2. 训练图像分类网络

#### 2.1 准备训练JSON配置文件

配置文件示例

```
{
	"log_dir": "/data/aios/out/visiontl/cls",
	"dataset": {
		"data_root": "/data/aios/data/cls",
		"train_dir": "classification_train",
		"valid_dir": "classification_valid",
		"test_dir": "classification_test",
		"valid_size": 0.2,
		"test_size": 0.1
	},
	"gpus": [
		0
	],
	"model": {
		"base_network": "mobilenetv3_small",
		"use_pretrained": true,
		"use_gn": false,
		"batch_norm": false,
		"use_se": false,
		"last_gamma": false
	},
	"train": {
		"batch_size": 64,
		"num_workers": 16,
		"epochs": 100,
		"lr": 0.035,
		"lr_decay": 0.1,
		"lr_decay_period": 0,
		"lr_decay_epoch": "25,50,75",
		"lr_mode": "step",
		"warmup_lr": 0,
		"warmup_epochs": 0,
		"momentum": 0.9,
		"teacher": null,
		"hard_weight": 0.5,
		"dtype": "float32",
		"input_width": 224,
		"input_height": 224,
		"mixup": false,
		"no_wd": false,
		"label_smoothing": false,
		"temperature": 20,
		"resume_epoch": 0,
		"mixup_alpha": 0.2,
		"mixup_off_epoch": 0,
		"mode": "hybrid",
		"start_epoch": 0,
		"transfer_lr_mult": 0.01,
		"output_lr_mult": 0.1,
		"optimizer": "adam",
		"wd": 0.0001,
		"log_interval": 50,
		"early_stop_patience": -1,
		"early_stop_min_delta": 0.001,
		"early_stop_baseline": 0,
		"early_stop_max_value": 1
	},
	"valid": {
		"interval": 1
	}
}
```

| 参数名                     | 默认值               | 参数类型 | 必填参数 | 参数描述           |                                                              |
| -------------------------- | -------------------- | -------- | -------- | ------------------ | ------------------------------------------------------------ |
| log_dir                    | 无                   | Text     | 必填     | 日志和结果保存目录 | 训练的日志：estimator.log<br/>训练的模型：xxx.json  xxx.params<br/>迭代使用文件：best_checkpoint.pkl<br/>验证集结果：valid_data_result.json<br/>测试集结果：test_data_result.json |
| dataset                    |                      | Text     |          |                    |                                                              |
| dataset.data_root          | /data/aios/data/cls  | Text     | 必填     | 训练数据根目录     | 训练集，验证集，测试集存放的根目录                           |
| dataset.train_dir          | classification_train | Text     | 必填     | 训练集数据子目录名 | 训练集相对路径                                               |
| dataset.valid_dir          | classification_valid | Text     | 可选     | 验证集数据子目录名 | 验证集相对路径                                               |
| dataset.test_dir           | classification_test  | Text     | 可选     | 测试集数据子目录名 | 测试集相对路径                                               |
| dataset.valid_size         | 0                    | Text     | 高级     | 验证集比例         | 取值范围[0, 1)<br>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分valid_size作为验证集数据 |
| dataset.test_size          | 0                    | Text     | 高级     | 测试集比例         | 取值范围[0, 1)<br/>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分test_size作为测试集数据 |
| gpus                       | 0                    | Text     | 必填     | 训练使用的GPU卡ID  | 指定训练使用的GPU卡ID                                        |
| model                      |                      | Text     |          |                    |                                                              |
| model.base_network         | resnet50_v1          | Text     | 必填     | 骨干网络           | 可选骨干网络列表：<br>resnet18_v1<br>resnet34_v1<br>resnet50_v1<br>resnet101_v1<br>resnet152_v1<br><br>resnet18_v2<br>resnet34_v2<br>resnet50_v2<br>resnet101_v2<br>resnet152_v2<br><br>mobilenet1.0<br>mobilenet0.75<br>mobilenet0.5<br>mobilenet0.25<br><br>mobilenetv2_1.0<br>mobilenetv2_0.75<br>mobilenetv2_0.5<br>mobilenetv2_0.25<br><br>mobilenetv3_large<br>mobilenetv3_small<br><br>densenet121<br>densenet161<br>densenet169<br>densenet201<br><br>vgg11<br>vgg13<br>vgg16<br>vgg19 |
| model.use_pretrained       | true                 | Text     | 可选     | 是否使用预训练模型 |                                                              |
| model.use_gn               | false                | Text     |          |                    |                                                              |
| model.batch_norm           | false                | Text     |          |                    |                                                              |
| model.use_se               | false                | Text     |          |                    |                                                              |
| model.last_gamma           | false                | Text     |          |                    |                                                              |
| train                      | -                    | Text     |          |                    |                                                              |
| train.batch_size           | 64                   | Text     |          |                    |                                                              |
| train.num_workers          | 16                   | Text     | 可选     |                    | cpu workers, the larger the more processes used              |
| train.epochs               | 100                  | Text     |          |                    |                                                              |
| train.lr                   | 0.035                | Text     | 可选     | 学习率             |                                                              |
| train.lr_decay             | 0.1                  | Text     | 高级     | 学习率衰减系数     |                                                              |
| train.lr_decay_period      | 0                    | Text     |          |                    |                                                              |
| train.lr_decay_epoch       | 25,50,75             | Text     | 高级     | 学习率消减步数     | lr_mode为step时生效                                          |
| train.lr_mode              | step                 | Text     | 高级     | 学习率衰减模式     | 可选模式<br>step<br>poly<br>cosine                           |
| train.warmup_lr            | 0                    | Text     | 高级     |                    | starting warmup learning rate                                |
| train.warmup_epochs        | 0                    | Text     | 高级     |                    | number of warmup epochs                                      |
| train.momentum             | 0.9                  | Text     | 高级     |                    | SGD momentum                                                 |
| train.teacher              | -                    | Text     | 高级     |                    |                                                              |
| train.hard_weight          | 0.5                  | Text     | 高级     |                    |                                                              |
| train.dtype                | float32              | Text     | 高级     |                    |                                                              |
| train.input_width          | 224                  | Text     | 必填     |                    |                                                              |
| train.input_height         | 224                  | Text     | 必填     |                    |                                                              |
| train.mixup                | false                | Text     | 高级     |                    |                                                              |
| train.no_wd                | false                | Text     |          |                    |                                                              |
| train.label_smoothing      | false                | Text     | 高级     |                    |                                                              |
| train.temperature          | 20                   | Text     | 高级     |                    |                                                              |
| train.resume_epoch         | 0                    | Text     |          |                    |                                                              |
| train.mixup_alpha          | 0.2                  | Text     | 高级     |                    |                                                              |
| train.mixup_off_epoch      | 0                    | Text     | 高级     |                    |                                                              |
| train.mode                 | hybrid               | Text     |          |                    |                                                              |
| train.start_epoch          | 0                    | Text     | 高级     |                    |                                                              |
| train.transfer_lr_mult     | 0.01                 | Text     | 高级     |                    | reduce the backbone lr_mult to avoid quickly destroying the features |
| train.output_lr_mult       | 0.1                  | Text     | 高级     |                    | the learning rate multiplier for last fc layer if trained with transfer learning |
| train.optimizer            | adam                 | Text     | 高级     |                    |                                                              |
| train.wd                   | 0.0001               | Text     | 高级     |                    |                                                              |
| train.log_interval         | 50                   | Text     |          |                    |                                                              |
| train.early_stop_patience  | -1                   | Text     | 高级     |                    | epochs with no improvement after which train is early stopped, negative: disabled |
| train.early_stop_min_delta | 0.001                | Text     | 高级     |                    | ignore changes less than min_delta for metrics               |
| train.early_stop_baseline  | 0                    | Text     | 高级     |                    | the baseline value for metric, training won't stop if not reaching baseline |
| train.early_stop_max_value | 1                    | Text     | 高级     |                    | early stop if reaching max value instantly                   |
| valid                      | -                    | Text     |          |                    |                                                              |
| valid.interval             | 1                    | Text     | 高级     |                    | validation epoch interval, for slow validations              |



#### 2.2 启动模型训练

一个训练任务启动一个容器进行训练

 docker启动示例

```shell
nvidia-docker run -it --rm --shm-size=128G -p 8888:8888 -v /data/aios/data:/data -v /data/aios/out:/out mxnet_train:1.1.0 python3 classification/fit_classification.py --config image_classification.json
```

##### 2.2.1 nvidia-docker参数

`-v /data/aios/data:/data`

​		`/data/aios/data`：训练数据存放的路径，根据实际具体的存放路径填写

​		`/data`：挂载到容器内的路径

`-v /data/aios/out:/out`

​		`/data/aios/out`：训练结果保存的路径，根据实际具体路径填写

​		`/out`：挂载到容器内的路径

`-p HOSTPORT:8888`：把容器内部端口8888映射到宿主机HOSTPORT端口上，用于获取进度

`--shm-size`：共享内存大小，建议设置大一些，否则影响训练

##### 2.2.2 python脚本参数

`--config`：配置文件，详细设置见2.1

`--load`:  需要进行迭代训练时才设置，加载上次训练得到的best_checkpoint.pkl文件。非迭代训练时，请勿设置。

​                 当使用迭代训练时，配置文件中model字段的参数无效。



### 3. 获取训练结果

训练结果会产生在配置文件中的`log_dir`目录



#### 3.1 训练日志estimator.log



#### 3.2 验证集结果valid_data_result.json

JSON文件内容如下：

```json
{
    "Accuray": "0.7366956521739131",
    "Result": [
        {
            "class": "brick",
            "score": 0.8858431577682495,
            "id": 0,
            "image": "/data/aios/data/cls/classification_valid/brick/brick_000021.jpg",
            "groundtruth": "brick",
            "result": "True"
        },
        {
            "class": "hair",
            "score": 0.6771479845046997,
            "id": 7,
            "image": "/data/aios/data/cls/classification_valid/brick/brick_000027.jpg",
            "groundtruth": "brick",
            "result": "False"
        }
    ]
}
```



#### 3.3 测试集结果test_data_result.json

与3.2一致



#### 3.4 本次训练最优模型xxx.json  xxx.params



#### 3.5 迭代训练使用的文件best_checkpoint.pkl



### 4. 获取进度

#### 4.1 接口URL

> http://0.0.0.0:8888/data/plugin/scalars/scalars?run=.&tag=progress

#### 4.2 请求方式

> POST

#### 4.3 成功响应示例

```
[
    [1629087911.0446773,        1,        0.0],
    [1629087911.346133,         1,        1.0],
    [1629087911.346491,         2,        0.0],
    [1629087911.3539176,        2,      0.01785714365541935],
    [1629087911.4217741,        2,        1.0],
    [1629087911.422071,         4,        0.0],
    [1629087911.495037,         4,        1.0],
    [1629087918.0763917,       10,        0.0],
    [1629087937.983495,        10,        1.0],
    [1629087939.968718,        20,        0.0],
    [1629087942.8499782,       20,        1.0],
    [1629087942.870176,        21,        0.0],
    [1629087945.651394,        21,        1.0],
    [1629087953.271594,        30,        0.0],
    [1629087959.218388,        30,        1.0]
]
```

| 参数名    | 参数描述 | 备注                                                         |
| --------- | -------- | ------------------------------------------------------------ |
| timestamp | 时间戳   | 当前条目产生的时间戳                                         |
| step      | 当前步骤 | LOAD_TRAIN_DATA = 1                        加载训练集<br/>LOAD_VALID_DATA = 2                         加载验证集<br/>LOAD_TRAIN_VALID_DATA = 3            加载训练集和验证集<br/>LOAD_TEST_DATA = 4                           加载测试集<br/>LOAD_ALL_DATA = 7                             加载训练集，验证集和测试集<br/>TRAIN = 10                                              训练中<br/>PREDICT_VALID = 20                             获取验证集结果<br/>PREDICT_TEST = 21                               获取测试集结果<br/>EXPORT = 30                                           导出模型 |
| progress  | 进度     | 当前步骤进度的百分比                                         |

## 三、REID模型训练

### 1. 准备训练数据

#### 1.1 支持的图片格式

当前支持扩展名为`.jpg`、 `.jpeg`、 `.png`、 `.bmp`（注意大小写）的图片

若非以上格式图片，请使用图片格式转换工具转换为可支持类型图片，请勿强制修改扩展名



#### 1.2 标注文件

相同分类的图片放到已该分类命名的文件夹下。

例如一个三分类任务，三个类别索引为A，B，C，则

训练集数据存放格式为：train/A/\*\*\*\*.jpg、train/B/\*\*\*\*.jpg、train/C/\*\*\*\*.jpg

验证集数据存放格式为：valid/A/\*\*\*\*.jpg、valid/B/\*\*\*\*.jpg、valid/C/\*\*\*\*.jpg

如果是带目标框的，每张图片需要有一个对应的TXT文件，需与图片文件名一致，且放在同一目录下，例如：1.jpg，1.txt。



#### 1.3 目录结构

```
/data
├── train                         // 训练集
│   ├── class01                   // 类别0，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class02                   // 类别1，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class03                   // 类别2，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class04                   // 类别3，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt

├── valid                         // 验证集
│   ├── class01                   // 类别0，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class02                   // 类别1，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class03                   // 类别2，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class04                   // 类别3，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt

├── test                          // 测试集
│   ├── class01                   // 类别0，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class02                   // 类别1，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class03                   // 类别2，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
│   ├── class04                   // 类别3，目录名为该分类的名称
│   │   ├── 000000.jpg
│   │   ├── 000000.txt
```



### 2. 训练REID网络

#### 2.1 准备JSON配置文件

与图像分类模型一致



#### 2.2 启动模型训练

一个训练任务启动一个容器进行训练

 docker启动示例

```shell
nvidia-docker run -it --rm --shm-size=128G -p 8888:8888 -v /data/aios/data:/data -v /data/aios/out:/out mxnet_train:1.1.0 python3 reid/fit_reid.py --config reid.json
```

##### 2.2.1 nvidia-docker参数

`-v /data/aios/data:/data`

​		`/data/aios/data`：训练数据存放的路径，根据实际具体的存放路径填写

​		`/data`：挂载到容器内的路径

`-v /data/aios/out:/out`

​		`/data/aios/out`：训练结果保存的路径，根据实际具体路径填写

​		`/out`：挂载到容器内的路径

`-p HOSTPORT:8888`：把容器内部端口8888映射到宿主机HOSTPORT端口上，用于获取进度

`--shm-size`：共享内存大小，建议设置大一些，否则影响训练

##### 2.2.2 python脚本参数

`--config`：配置文件，详细设置见2.1

`--load`:  需要进行迭代训练时才设置，加载上次训练得到的best_checkpoint.pkl文件。非迭代训练时，请勿设置。

​                 当使用迭代训练时，配置文件中model字段的参数无效。



#### 2.3 模型的特征维度



### 3. 获取训练结果

与图像分类一致



### 4. 获取进度

与图像分类一致



## 四、关键点模型训练

### 1. 准备训练数据

需要准备三个训练图片集：训练集、验证集和测试集（可选）



#### 1.1 支持的图片格式

当前支持扩展名为`.jpg`、 `.jpeg`、 `.png`、 `.bmp`（注意大小写）的图片

若非以上格式图片，请使用图片格式转换工具转换为可支持类型图片，请勿强制修改扩展名



#### 1.2 标注文件

| 参数名 | 说明        |
| ------ | ----------- |
| x      | 关键点x坐标 |
| y      | 关键点y坐标 |

每张图片需要有一个对应的标注TXT文件，需与图片文件名一致，且放在同一目录下，例如：1.jpg，1.txt。

标注TXT文件中，每一行表示一个关键点坐标。

假设有三个关键点0，则标注TXT文件如下：

```
x1,y1
x2,y2
x3,y3
```

#### 1.3 目录结构

三个训练图片集请按以下目录结构放置。

```
/data                             // 训练数据的根目录，对应配置文件中参数dataset.data_root
├── landmark_train                // 训练集数据文件夹，对应配置文件中参数dataset.train_dir
│   ├── 000000000009.jpg          // 图片
│   ├── 000000000009.txt          // 图片对应标注文件，格式：id,x1,y1,x2,y2
│   ├── 000000000025.jpg
│   ├── 000000000025.txt
│   ├── 000000000030.jpg
│   ├── 000000000030.txt
│   ├── 000000000034.jpg
│   ├── 000000000034.txt

├── landmark_valid                // 验证集集数据文件夹，对应配置文件中参数dataset.valid_dir
│   ├── 000000000139.jpg
│   ├── 000000000139.txt
│   ├── 000000000285.jpg
│   ├── 000000000285.txt
│   ├── 000000000632.jpg
│   ├── 000000000632.txt

├── landmark_test                 // 测试集集数据文件夹，对应配置文件中参数dataset.test_dir
│   ├── 000000002139.jpg
│   ├── 000000002139.txt
│   ├── 000000002285.jpg
│   ├── 000000002285.txt
│   ├── 000000002632.jpg
│   ├── 000000002632.txt
```

### 2. 训练Landmark网络

#### 2.1 准备训练JSON配置文件

配置文件示例

```json
{
  "log_dir": "/data/aios/out/visiontl/landmark",
  "dataset": {
    "data_root": "/data/aios/data/landmark",
    "train_dir": "train",
    "valid_dir": "valid",
    "test_dir": "test",
    "valid_size": 0.2,
    "test_size": 0.1,
    "num_joints": 68
  },
  "gpus": [
    0
  ],
  "model": {
    "base_network": "resnet18_v2",
    "use_pretrained": true,
    "use_gn": false,
    "batch_norm": false,
    "use_se": false,
    "last_gamma": false
  },
  "train": {
    "batch_size": 128,
    "num_workers": 16,
    "epochs": 60,
    "lr": 0.01,
    "lr_decay": 0.1,
    "lr_decay_period": 0,
    "lr_decay_epoch": "40, 60",
    "lr_mode": "step",
    "warmup_lr": 0.0,
    "warmup_epochs": 0,
    "momentum": 0.9,
    "teacher": null,
    "hard_weight": 0.5,
    "dtype": "float32",
    "input_width": 224,
    "input_height": 224,
    "mixup": false,
    "no_wd": false,
    "label_smoothing": false,
    "temperature": 20,
    "resume_epoch": 0,
    "mixup_alpha": 0.2,
    "mixup_off_epoch": 0,
    "mode": "hybrid",
    "start_epoch": 0,
    "transfer_lr_mult": 0.01,
    "output_lr_mult": 0.1,
    "optimizer": "adam",
    "wd": 0.0,
    "log_interval": 20,
    "early_stop_patience": -1,
    "early_stop_min_delta": 0.001,
    "early_stop_baseline": 0.0,
    "early_stop_max_value": 0.0
  },
  "valid": {
    "interval": 1
  }
}
```

| 参数名                     | 默认值               | 参数类型 | 必填参数 | 参数描述           |                                                              |
| -------------------------- | -------------------- | -------- | -------- | ------------------ | ------------------------------------------------------------ |
| log_dir                    | 无                   | Text     | 必填     | 日志和结果保存目录 | 训练的日志：estimator.log<br/>训练的模型：xxx.json  xxx.params<br/>迭代使用文件：best_checkpoint.pkl<br/>验证集结果：valid_data_result.json<br/>测试集结果：test_data_result.json |
| dataset                    |                      | Text     |          |                    |                                                              |
| dataset.data_root          | /data/aios/data/cls  | Text     | 必填     | 训练数据根目录     | 训练集，验证集，测试集存放的根目录                           |
| dataset.train_dir          | classification_train | Text     | 必填     | 训练集数据子目录名 | 训练集相对路径                                               |
| dataset.valid_dir          | classification_valid | Text     | 可选     | 验证集数据子目录名 | 验证集相对路径                                               |
| dataset.test_dir           | classification_test  | Text     | 可选     | 测试集数据子目录名 | 测试集相对路径                                               |
| dataset.valid_size         | 0                    | Text     | 高级     | 验证集比例         | 取值范围[0, 1)<br>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分valid_size作为验证集数据 |
| dataset.test_size          | 0                    | Text     | 高级     | 测试集比例         | 取值范围[0, 1)<br/>当只设置detect_train目录，detect_valid和detect_test设为None，则从训练集数据中分test_size作为测试集数据 |
| dataset.num_joints         | 68                   | Text     | 必填     | 关键点个数         |                                                              |
| gpus                       | 0                    | Text     | 必填     | 训练使用的GPU卡ID  | 指定训练使用的GPU卡ID                                        |
| model                      |                      | Text     |          |                    |                                                              |
| model.base_network         | resnet50_v1          | Text     | 必填     | 骨干网络           | 可选骨干网络列表：<br>resnet18_v1<br>resnet34_v1<br>resnet50_v1<br>resnet101_v1<br>resnet152_v1<br><br>resnet18_v2<br>resnet34_v2<br>resnet50_v2<br>resnet101_v2<br>resnet152_v2<br><br>mobilenet1.0<br>mobilenet0.75<br>mobilenet0.5<br>mobilenet0.25<br><br>mobilenetv2_1.0<br>mobilenetv2_0.75<br>mobilenetv2_0.5<br>mobilenetv2_0.25<br><br>mobilenetv3_large<br>mobilenetv3_small<br><br>densenet121<br>densenet161<br>densenet169<br>densenet201<br><br>vgg11<br>vgg13<br>vgg16<br>vgg19 |
| model.use_pretrained       | true                 | Text     | 可选     | 是否使用预训练模型 |                                                              |
| model.use_gn               | false                | Text     |          |                    |                                                              |
| model.batch_norm           | false                | Text     |          |                    |                                                              |
| model.use_se               | false                | Text     |          |                    |                                                              |
| model.last_gamma           | false                | Text     |          |                    |                                                              |
| train                      | -                    | Text     |          |                    |                                                              |
| train.batch_size           | 64                   | Text     |          |                    |                                                              |
| train.num_workers          | 16                   | Text     | 可选     |                    | cpu workers, the larger the more processes used              |
| train.epochs               | 100                  | Text     |          |                    |                                                              |
| train.lr                   | 0.035                | Text     | 可选     | 学习率             |                                                              |
| train.lr_decay             | 0.1                  | Text     | 高级     | 学习率衰减系数     |                                                              |
| train.lr_decay_period      | 0                    | Text     |          |                    |                                                              |
| train.lr_decay_epoch       | 25,50,75             | Text     | 高级     | 学习率消减步数     | lr_mode为step时生效                                          |
| train.lr_mode              | step                 | Text     | 高级     | 学习率衰减模式     | 可选模式<br>step<br>poly<br>cosine                           |
| train.warmup_lr            | 0                    | Text     | 高级     |                    | starting warmup learning rate                                |
| train.warmup_epochs        | 0                    | Text     | 高级     |                    | number of warmup epochs                                      |
| train.momentum             | 0.9                  | Text     | 高级     |                    | SGD momentum                                                 |
| train.teacher              | -                    | Text     | 高级     |                    |                                                              |
| train.hard_weight          | 0.5                  | Text     | 高级     |                    |                                                              |
| train.dtype                | float32              | Text     | 高级     |                    |                                                              |
| train.input_width          | 224                  | Text     | 必填     |                    |                                                              |
| train.input_height         | 224                  | Text     | 必填     |                    |                                                              |
| train.mixup                | false                | Text     | 高级     |                    |                                                              |
| train.no_wd                | false                | Text     |          |                    |                                                              |
| train.label_smoothing      | false                | Text     | 高级     |                    |                                                              |
| train.temperature          | 20                   | Text     | 高级     |                    |                                                              |
| train.resume_epoch         | 0                    | Text     |          |                    |                                                              |
| train.mixup_alpha          | 0.2                  | Text     | 高级     |                    |                                                              |
| train.mixup_off_epoch      | 0                    | Text     | 高级     |                    |                                                              |
| train.mode                 | hybrid               | Text     |          |                    |                                                              |
| train.start_epoch          | 0                    | Text     | 高级     |                    |                                                              |
| train.transfer_lr_mult     | 0.01                 | Text     | 高级     |                    | reduce the backbone lr_mult to avoid quickly destroying the features |
| train.output_lr_mult       | 0.1                  | Text     | 高级     |                    | the learning rate multiplier for last fc layer if trained with transfer learning |
| train.optimizer            | adam                 | Text     | 高级     |                    |                                                              |
| train.wd                   | 0.0001               | Text     | 高级     |                    |                                                              |
| train.log_interval         | 50                   | Text     |          |                    |                                                              |
| train.early_stop_patience  | -1                   | Text     | 高级     |                    | epochs with no improvement after which train is early stopped, negative: disabled |
| train.early_stop_min_delta | 0.001                | Text     | 高级     |                    | ignore changes less than min_delta for metrics               |
| train.early_stop_baseline  | 0                    | Text     | 高级     |                    | the baseline value for metric, training won't stop if not reaching baseline |
| train.early_stop_max_value | 1                    | Text     | 高级     |                    | early stop if reaching max value instantly                   |
| valid                      | -                    | Text     |          |                    |                                                              |
| valid.interval             | 1                    | Text     | 高级     |                    | validation epoch interval, for slow validations              |

#### 2.2 启动模型训练

一个训练任务启动一个容器进行训练

 docker启动示例

```shell
nvidia-docker run -it --rm --shm-size=128G -p 8888:8888 -v /data/aios/data:/data -v /data/aios/out:/out mxnet_train:1.1.0 python3 landmark/fit_landmark.py --config landmark.json
```

##### 2.2.1 nvidia-docker参数

`-v /data/aios/data:/data`

​		`/data/aios/data`：训练数据存放的路径，根据实际具体的存放路径填写

​		`/data`：挂载到容器内的路径

`-v /data/aios/out:/out`

​		`/data/aios/out`：训练结果保存的路径，根据实际具体路径填写

​		`/out`：挂载到容器内的路径

`-p HOSTPORT:8888`：把容器内部端口8888映射到宿主机HOSTPORT端口上，用于获取进度

`--shm-size`：共享内存大小，建议设置大一些，否则影响训练

##### 2.2.2 python脚本参数

`--config`：配置文件，详细设置见2.1

`--load`:  需要进行迭代训练时才设置，加载上次训练得到的best_checkpoint.pkl文件。非迭代训练时，请勿设置。

​                 当使用迭代训练时，配置文件中model字段的参数无效。



### 3. 获取训练结果

训练结果会产生在配置文件中的`log_dir`目录



#### 3.1 训练日志estimator.log



#### 3.2 验证集结果valid_data_result.json

JSON文件内容如下：

```json
{
    "RMSE": 1.720215634063438,
    "Result": [
        {
            "keypoints": [
                {"x": 223.72865295410156, "y": 0.0},
                {"x": 230.0,              "y": 0.0},
				....................................
                {"x": 229.11729431152344, "y": 97.91839599609375}
            ],
            "image": "/data/aios/data/landmark/test/134212_2.jpg",
            "groundtruth": [
                {"x": 13.589493, "y": 15.037628},
                {"x": 11.37674,  "y": 45.45903},
                .....................................
                {"x": 109.608826,"y": 143.827484}
            ]
        },
        {
            "keypoints": [
                {"x": 223.72865295410156, "y": 0.0},
                {"x": 230.0,              "y": 0.0},
				....................................
                {"x": 229.11729431152344, "y": 97.91839599609375}
            ],
            "image": "/data/aios/data/landmark/test/134212_3.jpg",
            "groundtruth": [
                {"x": 13.589493, "y": 15.037628},
                {"x": 11.37674,  "y": 45.45903},
                .....................................
                {"x": 109.608826,"y": 143.827484}
            ]
        }
    ]
}
```



#### 3.3 测试集结果test_data_result.json

与3.2一致



#### 3.4 本次训练最优模型xxx.json  xxx.params



#### 3.5 迭代训练使用的文件best_checkpoint.pkl



### 4. 获取进度

#### 4.1 接口URL

> http://0.0.0.0:8888/data/plugin/scalars/scalars?run=.&tag=progress

#### 4.2 请求方式

> POST

#### 4.3 成功响应示例

```
[
    [1629087911.0446773,        1,        0.0],
    [1629087911.346133,         1,        1.0],
    [1629087911.346491,         2,        0.0],
    [1629087911.3539176,        2,      0.01785714365541935],
    [1629087911.4217741,        2,        1.0],
    [1629087911.422071,         4,        0.0],
    [1629087911.495037,         4,        1.0],
    [1629087918.0763917,       10,        0.0],
    [1629087937.983495,        10,        1.0],
    [1629087939.968718,        20,        0.0],
    [1629087942.8499782,       20,        1.0],
    [1629087942.870176,        21,        0.0],
    [1629087945.651394,        21,        1.0],
    [1629087953.271594,        30,        0.0],
    [1629087959.218388,        30,        1.0]
]
```

| 参数名    | 参数描述 | 备注                                                         |
| --------- | -------- | ------------------------------------------------------------ |
| timestamp | 时间戳   | 当前条目产生的时间戳                                         |
| step      | 当前步骤 | LOAD_TRAIN_DATA = 1                        加载训练集<br/>LOAD_VALID_DATA = 2                         加载验证集<br/>LOAD_TRAIN_VALID_DATA = 3            加载训练集和验证集<br/>LOAD_TEST_DATA = 4                           加载测试集<br/>LOAD_ALL_DATA = 7                             加载训练集，验证集和测试集<br/>TRAIN = 10                                              训练中<br/>PREDICT_VALID = 20                             获取验证集结果<br/>PREDICT_TEST = 21                               获取测试集结果<br/>EXPORT = 30                                           导出模型 |
| progress  | 进度     | 当前步骤进度的百分比                                         |

## 
